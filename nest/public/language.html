<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËØ≠Ë®ÄÂÅèÂ•ΩËÆæÁΩÆ</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-hover: #45a049;
            --text-color: #333;
            --light-text: #666;
            --border-color: #ddd;
            --error-color: #f44336;
            --success-color: #4CAF50;
            --bg-color: #f5f5f5;
            --card-bg: white;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
            padding: 20px 0;
        }

        .container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        h1 {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--light-text);
            font-weight: bold;
        }

        select, input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        .search-box {
            margin-bottom: 1rem;
            position: relative;
        }

        .search-box input {
            padding-left: 2.5rem;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 12px;
            color: var(--light-text);
        }

        .language-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .language-option:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .language-option.selected {
            background-color: rgba(76, 175, 80, 0.2);
            font-weight: bold;
        }

        .language-option:last-child {
            border-bottom: none;
        }

        .current-lang {
            color: var(--primary-color);
            font-weight: bold;
        }

        button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        .links {
            text-align: center;
            margin-top: 1.5rem;
        }

        .links a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .links a:hover {
            text-decoration: underline;
        }

        .message {
            margin-top: 1rem;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            display: none;
        }

        .success {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }

        .error {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--error-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="title">ËØ≠Ë®ÄÂÅèÂ•ΩËÆæÁΩÆ</h1>
        <div id="message" class="message"></div>
        
        <div class="form-group">
            <label for="language-search" id="label-search">ÊêúÁ¥¢ËØ≠Ë®ÄÔºö</label>
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="language-search" placeholder="ËæìÂÖ•ËØ≠Ë®ÄÂêçÁß∞ÊêúÁ¥¢...">
            </div>
            
            <div class="language-list" id="language-list">
                <!-- ËØ≠Ë®ÄÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
        
        <button id="saveBtn">‰øùÂ≠òËÆæÁΩÆ</button>
        
        <div class="links">
            <a href="login.html" id="back-to-login">ËøîÂõûÁôªÂΩïÈ°µÈù¢</a>
        </div>
    </div>

    <script>
        // ËØ≠Ë®ÄÂàóË°® - ÊîØÊåÅÊâ©Â±ïÂà∞100+ËØ≠Ë®Ä
        const languages = [
            { code: 'zh', name: '‰∏≠Êñá (Chinese)', localName: '‰∏≠Êñá' },
            { code: 'en', name: 'English', localName: 'English' },
            { code: 'es', name: 'Spanish', localName: 'Espa√±ol' },
            { code: 'fr', name: 'French', localName: 'Fran√ßais' },
            { code: 'de', name: 'German', localName: 'Deutsch' },
            { code: 'it', name: 'Italian', localName: 'Italiano' },
            { code: 'ja', name: 'Japanese', localName: 'Êó•Êú¨Ë™û' },
            { code: 'ko', name: 'Korean', localName: 'ÌïúÍµ≠Ïñ¥' },
            { code: 'ru', name: 'Russian', localName: '–†—É—Å—Å–∫–∏–π' },
            { code: 'pt', name: 'Portuguese', localName: 'Portugu√™s' },
            { code: 'ar', name: 'Arabic', localName: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' },
            { code: 'hi', name: 'Hindi', localName: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä' },
            { code: 'bn', name: 'Bengali', localName: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' },
            { code: 'id', name: 'Indonesian', localName: 'Bahasa Indonesia' },
            { code: 'tr', name: 'Turkish', localName: 'T√ºrk√ße' },
            { code: 'vi', name: 'Vietnamese', localName: 'Ti·∫øng Vi·ªát' },
            { code: 'th', name: 'Thai', localName: '‡πÑ‡∏ó‡∏¢' }
            // ÂèØ‰ª•Ê†πÊçÆÈúÄË¶ÅÁªßÁª≠Ê∑ªÂä†Êõ¥Â§öËØ≠Ë®Ä
        ];

        // Â§öËØ≠Ë®ÄÊîØÊåÅ
        const translations = {
            'zh': {
                'title': 'ËØ≠Ë®ÄÂÅèÂ•ΩËÆæÁΩÆ',
                'label-search': 'ÊêúÁ¥¢ËØ≠Ë®ÄÔºö',
                'search-placeholder': 'ËæìÂÖ•ËØ≠Ë®ÄÂêçÁß∞ÊêúÁ¥¢...',
                'save-button': '‰øùÂ≠òËÆæÁΩÆ',
                'back-to-login': 'ËøîÂõûÁôªÂΩïÈ°µÈù¢',
                'message-success': 'ËØ≠Ë®ÄÂÅèÂ•ΩÂ∑≤Êõ¥Êñ∞',
                'message-error': 'Êõ¥Êñ∞ËØ≠Ë®ÄÂÅèÂ•ΩÊó∂Âá∫Èîô',
                'message-auth-error': 'ÊÇ®ÈúÄË¶ÅÁôªÂΩïÊâçËÉΩÊõ¥ÊîπËØ≠Ë®ÄÂÅèÂ•Ω',
                'current-language': 'ÂΩìÂâçËØ≠Ë®Ä'
            },
            'en': {
                'title': 'Language Preferences',
                'label-search': 'Search Languages:',
                'search-placeholder': 'Type to search languages...',
                'save-button': 'Save Settings',
                'back-to-login': 'Back to Login',
                'message-success': 'Language preference updated',
                'message-error': 'Error updating language preference',
                'message-auth-error': 'You need to be logged in to change language preferences',
                'current-language': 'Current language'
            }
        };

        // Ëé∑ÂèñURLÂèÇÊï∞
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            
            params.clientId = urlParams.get('client_id');
            params.redirectUri = urlParams.get('redirect_uri');
            params.responseType = urlParams.get('response_type');
            params.scope = urlParams.get('scope');
            params.state = urlParams.get('state');
            params.language = urlParams.get('lang');
            
            return params;
        }

        // Â∫îÁî®ÂΩìÂâçËØ≠Ë®ÄÁøªËØë
        function applyLanguage(lang) {
            if (!translations[lang]) {
                lang = 'zh'; // ÈªòËÆ§‰∏≠Êñá
            }
            
            // Êõ¥Êñ∞È°µÈù¢‰∏äÁöÑÊâÄÊúâÊñáÊú¨
            document.getElementById('title').textContent = translations[lang]['title'];
            document.getElementById('label-search').textContent = translations[lang]['label-search'];
            document.getElementById('language-search').placeholder = translations[lang]['search-placeholder'];
            document.getElementById('saveBtn').textContent = translations[lang]['save-button'];
            document.getElementById('back-to-login').textContent = translations[lang]['back-to-login'];

            // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
            document.title = translations[lang]['title'];
            
            // ‰øùÂ≠òËØ≠Ë®ÄÈÄâÊã©Ôºà‰∏çÈÄöËøáAPIÔºå‰ªÖÊú¨Âú∞‰øùÂ≠òÔºâ
            localStorage.setItem('preferred_language', lang);
            
            // Âú®ËØ≠Ë®ÄÂàóË°®‰∏≠Ê†áËÆ∞ÂΩìÂâçÈÄâÊã©ÁöÑËØ≠Ë®Ä
            renderLanguageList(lang);
            
            // Êõ¥Êñ∞ÈìæÊé•‰∏≠ÁöÑËØ≠Ë®ÄÂèÇÊï∞
            updateLinksWithParams(lang);
        }
        
        // Êõ¥Êñ∞ÈìæÊé•‰ª•‰øùÁïôURLÂèÇÊï∞
        function updateLinksWithParams(lang) {
            const params = getUrlParams();
            
            // Ëé∑ÂèñÊâÄÊúâÈìæÊé•
            const links = document.querySelectorAll('a');
            
            links.forEach(link => {
                const url = new URL(link.href);
                const baseUrl = url.origin + url.pathname;
                const urlParams = new URLSearchParams();
                
                // Ê∑ªÂä†ÊâÄÊúâÂèÇÊï∞
                if (params.clientId) urlParams.set('client_id', params.clientId);
                if (params.redirectUri) urlParams.set('redirect_uri', params.redirectUri);
                if (params.responseType) urlParams.set('response_type', params.responseType);
                if (params.scope) urlParams.set('scope', params.scope);
                if (params.state) urlParams.set('state', params.state);
                
                // ËÆæÁΩÆÂΩìÂâçËØ≠Ë®Ä
                urlParams.set('lang', lang);
                
                // Êõ¥Êñ∞ÈìæÊé•
                link.href = baseUrl + '?' + urlParams.toString();
            });
        }

        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(message, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        // Ê∏≤ÊüìËØ≠Ë®ÄÂàóË°®
        function renderLanguageList(selectedLang) {
            const languageList = document.getElementById('language-list');
            const searchTerm = document.getElementById('language-search').value.toLowerCase();
            
            // Ê∏ÖÁ©∫ÂΩìÂâçÂàóË°®
            languageList.innerHTML = '';
            
            // Á≠õÈÄâËØ≠Ë®Ä
            const filteredLanguages = languages.filter(lang => 
                lang.name.toLowerCase().includes(searchTerm) || 
                lang.localName.toLowerCase().includes(searchTerm) ||
                lang.code.toLowerCase().includes(searchTerm)
            );
            
            // ÂàõÂª∫ËØ≠Ë®ÄÈÄâÈ°π
            filteredLanguages.forEach(lang => {
                const option = document.createElement('div');
                option.className = `language-option ${lang.code === selectedLang ? 'selected' : ''}`;
                option.dataset.code = lang.code;
                
                let displayText = `${lang.localName} (${lang.name})`;
                
                // Â¶ÇÊûúËøôÊòØÂΩìÂâçÈÄâÊã©ÁöÑËØ≠Ë®ÄÔºåÊ∑ªÂä†Ê†áËÆ∞
                if (lang.code === selectedLang) {
                    const currentLang = document.createElement('span');
                    currentLang.className = 'current-lang';
                    currentLang.textContent = ` ‚úì ${translations[selectedLang]['current-language']}`;
                    option.innerHTML = displayText;
                    option.appendChild(currentLang);
                } else {
                    option.textContent = displayText;
                }
                
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                option.addEventListener('click', () => {
                    selectLanguage(lang.code);
                });
                
                languageList.appendChild(option);
            });
            
            // Â¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÁöÑËØ≠Ë®Ä
            if (filteredLanguages.length === 0) {
                const noResult = document.createElement('div');
                noResult.className = 'language-option';
                noResult.textContent = 'Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑËØ≠Ë®Ä / No matching languages found';
                languageList.appendChild(noResult);
            }
        }

        // ÈÄâÊã©ËØ≠Ë®Ä
        function selectLanguage(langCode) {
            // Êõ¥Êñ∞ÊâÄÊúâÈÄâÊã©Âô®ÁöÑÁä∂ÊÄÅ
            document.querySelectorAll('.language-option').forEach(option => {
                if (option.dataset.code === langCode) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            // Â∫îÁî®ËØ≠Ë®Ä
            applyLanguage(langCode);
        }

        // ‰øùÂ≠òËØ≠Ë®ÄÂÅèÂ•ΩÂà∞ÊúçÂä°Âô®
        async function saveLanguagePreference(langCode) {
            const currentLang = localStorage.getItem('preferred_language') || 'zh';
            
            try {
                const accessToken = localStorage.getItem('access_token');
                
                // Â¶ÇÊûúÊ≤°ÊúâÁôªÂΩïÔºåÊèêÁ§∫ÈîôËØØ
                if (!accessToken) {
                    showMessage(translations[currentLang]['message-auth-error'], 'error');
                    return;
                }
                
                const response = await fetch('/api/users/language', {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ language: langCode })
                });
                
                if (response.ok) {
                    showMessage(translations[currentLang]['message-success'], 'success');
                } else {
                    showMessage(translations[currentLang]['message-error'], 'error');
                }
            } catch (error) {
                console.error('Error saving language preference:', error);
                showMessage(translations[currentLang]['message-error'], 'error');
            }
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            const params = getUrlParams();
            const savedLang = localStorage.getItem('preferred_language');
            const currentLang = params.language || savedLang || 'zh';
            
            // Â∫îÁî®ÂΩìÂâçËØ≠Ë®Ä
            applyLanguage(currentLang);
            
            // ÊêúÁ¥¢Ê°Ü‰∫ã‰ª∂
            document.getElementById('language-search').addEventListener('input', () => {
                renderLanguageList(localStorage.getItem('preferred_language') || 'zh');
            });
            
            // ‰øùÂ≠òÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('saveBtn').addEventListener('click', async () => {
                const currentLang = localStorage.getItem('preferred_language') || 'zh';
                await saveLanguagePreference(currentLang);
            });
            
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                // Â¶ÇÊûúÊ≤°ÊúâÁôªÂΩïÔºåÂèØ‰ª•‰ªçÁÑ∂ÂÖÅËÆ∏Áî®Êà∑Êõ¥ÊîπËØ≠Ë®ÄÂÅèÂ•ΩÔºå‰ΩÜ‰∏ç‰ºö‰øùÂ≠òÂà∞ÊúçÂä°Âô®
                document.getElementById('message').textContent = translations[currentLang]['message-auth-error'];
                document.getElementById('message').className = 'message error';
                document.getElementById('message').style.display = 'block';
            } else {
                // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåËé∑ÂèñÁî®Êà∑ÁöÑÂΩìÂâçËØ≠Ë®ÄÂÅèÂ•Ω
                fetchUserProfile();
            }
        });
        
        // Ëé∑ÂèñÁî®Êà∑ÁöÑËØ≠Ë®ÄÂÅèÂ•Ω
        async function fetchUserProfile() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const currentLang = localStorage.getItem('preferred_language') || 'zh';
                
                const response = await fetch('/api/users/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Â¶ÇÊûúÁî®Êà∑ÊúâÂ∑≤‰øùÂ≠òÁöÑËØ≠Ë®ÄÂÅèÂ•ΩÔºåÂ∫îÁî®ÂÆÉ
                    if (data.preferredLanguage) {
                        applyLanguage(data.preferredLanguage);
                    }
                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
            }
        }
    </script>
</body>
</html> 