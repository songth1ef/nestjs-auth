<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­è¨€åå¥½è®¾ç½®</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-hover: #45a049;
            --text-color: #333;
            --light-text: #666;
            --border-color: #ddd;
            --error-color: #f44336;
            --success-color: #4CAF50;
            --bg-color: #f5f5f5;
            --card-bg: white;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
            padding: 20px 0;
        }

        .container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        h1 {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--light-text);
            font-weight: bold;
        }

        select, input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        .search-box {
            margin-bottom: 1rem;
            position: relative;
        }

        .search-box input {
            padding-left: 2.5rem;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 12px;
            color: var(--light-text);
        }

        .language-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .language-option:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .language-option.selected {
            background-color: rgba(76, 175, 80, 0.2);
            font-weight: bold;
        }

        .language-option:last-child {
            border-bottom: none;
        }

        .current-lang {
            color: var(--primary-color);
            font-weight: bold;
        }

        button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        .links {
            text-align: center;
            margin-top: 1.5rem;
        }

        .links a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .links a:hover {
            text-decoration: underline;
        }

        .message {
            margin-top: 1rem;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            display: none;
        }

        .success {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }

        .error {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--error-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="title">è¯­è¨€åå¥½è®¾ç½®</h1>
        <div id="message" class="message"></div>
        
        <div class="form-group">
            <label for="language-search" id="label-search">æœç´¢è¯­è¨€ï¼š</label>
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="language-search" placeholder="è¾“å…¥è¯­è¨€åç§°æœç´¢...">
            </div>
            
            <div class="language-list" id="language-list">
                <!-- è¯­è¨€åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <button id="saveBtn">ä¿å­˜è®¾ç½®</button>
        
        <div class="links">
            <a href="login.html" id="back-to-login">è¿”å›ç™»å½•é¡µé¢</a>
        </div>
    </div>

    <script>
        // è¯­è¨€åˆ—è¡¨ - æ”¯æŒæ‰©å±•åˆ°100+è¯­è¨€
        const languages = [
            { code: 'zh', name: 'ä¸­æ–‡ (Chinese)', localName: 'ä¸­æ–‡' },
            { code: 'en', name: 'English', localName: 'English' },
            { code: 'es', name: 'Spanish', localName: 'EspaÃ±ol' },
            { code: 'fr', name: 'French', localName: 'FranÃ§ais' },
            { code: 'de', name: 'German', localName: 'Deutsch' },
            { code: 'it', name: 'Italian', localName: 'Italiano' },
            { code: 'ja', name: 'Japanese', localName: 'æ—¥æœ¬èª' },
            { code: 'ko', name: 'Korean', localName: 'í•œêµ­ì–´' },
            { code: 'ru', name: 'Russian', localName: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' },
            { code: 'pt', name: 'Portuguese', localName: 'PortuguÃªs' },
            { code: 'ar', name: 'Arabic', localName: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' },
            { code: 'hi', name: 'Hindi', localName: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€' },
            { code: 'bn', name: 'Bengali', localName: 'à¦¬à¦¾à¦‚à¦²à¦¾' },
            { code: 'id', name: 'Indonesian', localName: 'Bahasa Indonesia' },
            { code: 'tr', name: 'Turkish', localName: 'TÃ¼rkÃ§e' },
            { code: 'vi', name: 'Vietnamese', localName: 'Tiáº¿ng Viá»‡t' },
            { code: 'th', name: 'Thai', localName: 'à¹„à¸—à¸¢' }
            // å¯ä»¥æ ¹æ®éœ€è¦ç»§ç»­æ·»åŠ æ›´å¤šè¯­è¨€
        ];

        // å¤šè¯­è¨€æ”¯æŒ
        const translations = {
            'zh': {
                'title': 'è¯­è¨€åå¥½è®¾ç½®',
                'label-search': 'æœç´¢è¯­è¨€ï¼š',
                'search-placeholder': 'è¾“å…¥è¯­è¨€åç§°æœç´¢...',
                'save-button': 'ä¿å­˜è®¾ç½®',
                'back-to-login': 'è¿”å›ç™»å½•é¡µé¢',
                'message-success': 'è¯­è¨€åå¥½å·²æ›´æ–°',
                'message-error': 'æ›´æ–°è¯­è¨€åå¥½æ—¶å‡ºé”™',
                'message-auth-error': 'æ‚¨éœ€è¦ç™»å½•æ‰èƒ½æ›´æ”¹è¯­è¨€åå¥½',
                'current-language': 'å½“å‰è¯­è¨€'
            },
            'en': {
                'title': 'Language Preferences',
                'label-search': 'Search Languages:',
                'search-placeholder': 'Type to search languages...',
                'save-button': 'Save Settings',
                'back-to-login': 'Back to Login',
                'message-success': 'Language preference updated',
                'message-error': 'Error updating language preference',
                'message-auth-error': 'You need to be logged in to change language preferences',
                'current-language': 'Current language'
            }
        };

        // è·å–URLå‚æ•°
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            
            params.clientId = urlParams.get('client_id');
            params.redirectUri = urlParams.get('redirect_uri');
            params.responseType = urlParams.get('response_type');
            params.scope = urlParams.get('scope');
            params.state = urlParams.get('state');
            params.language = urlParams.get('lang');
            
            return params;
        }

        // åº”ç”¨å½“å‰è¯­è¨€ç¿»è¯‘
        function applyLanguage(lang) {
            if (!translations[lang]) {
                lang = 'zh'; // é»˜è®¤ä¸­æ–‡
            }
            
            // æ›´æ–°é¡µé¢ä¸Šçš„æ‰€æœ‰æ–‡æœ¬
            document.getElementById('title').textContent = translations[lang]['title'];
            document.getElementById('label-search').textContent = translations[lang]['label-search'];
            document.getElementById('language-search').placeholder = translations[lang]['search-placeholder'];
            document.getElementById('saveBtn').textContent = translations[lang]['save-button'];
            document.getElementById('back-to-login').textContent = translations[lang]['back-to-login'];

            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.title = translations[lang]['title'];
            
            // ä¿å­˜è¯­è¨€é€‰æ‹©ï¼ˆä¸é€šè¿‡APIï¼Œä»…æœ¬åœ°ä¿å­˜ï¼‰
            localStorage.setItem('preferred_language', lang);
            
            // åœ¨è¯­è¨€åˆ—è¡¨ä¸­æ ‡è®°å½“å‰é€‰æ‹©çš„è¯­è¨€
            renderLanguageList(lang);
            
            // æ›´æ–°é“¾æ¥ä¸­çš„è¯­è¨€å‚æ•°
            updateLinksWithParams(lang);
        }
        
        // æ›´æ–°é“¾æ¥ä»¥ä¿ç•™URLå‚æ•°
        function updateLinksWithParams(lang) {
            const params = getUrlParams();
            
            // è·å–æ‰€æœ‰é“¾æ¥
            const links = document.querySelectorAll('a');
            
            links.forEach(link => {
                const url = new URL(link.href);
                const baseUrl = url.origin + url.pathname;
                const urlParams = new URLSearchParams();
                
                // æ·»åŠ æ‰€æœ‰å‚æ•°
                if (params.clientId) urlParams.set('client_id', params.clientId);
                if (params.redirectUri) urlParams.set('redirect_uri', params.redirectUri);
                if (params.responseType) urlParams.set('response_type', params.responseType);
                if (params.scope) urlParams.set('scope', params.scope);
                if (params.state) urlParams.set('state', params.state);
                
                // è®¾ç½®å½“å‰è¯­è¨€
                urlParams.set('lang', lang);
                
                // æ›´æ–°é“¾æ¥
                link.href = baseUrl + '?' + urlParams.toString();
            });
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        // æ¸²æŸ“è¯­è¨€åˆ—è¡¨
        function renderLanguageList(selectedLang) {
            const languageList = document.getElementById('language-list');
            const searchTerm = document.getElementById('language-search').value.toLowerCase();
            
            // æ¸…ç©ºå½“å‰åˆ—è¡¨
            languageList.innerHTML = '';
            
            // ç­›é€‰è¯­è¨€
            const filteredLanguages = languages.filter(lang => 
                lang.name.toLowerCase().includes(searchTerm) || 
                lang.localName.toLowerCase().includes(searchTerm) ||
                lang.code.toLowerCase().includes(searchTerm)
            );
            
            // åˆ›å»ºè¯­è¨€é€‰é¡¹
            filteredLanguages.forEach(lang => {
                const option = document.createElement('div');
                option.className = `language-option ${lang.code === selectedLang ? 'selected' : ''}`;
                option.dataset.code = lang.code;
                
                let displayText = `${lang.localName} (${lang.name})`;
                
                // å¦‚æœè¿™æ˜¯å½“å‰é€‰æ‹©çš„è¯­è¨€ï¼Œæ·»åŠ æ ‡è®°
                if (lang.code === selectedLang) {
                    const currentLang = document.createElement('span');
                    currentLang.className = 'current-lang';
                    currentLang.textContent = ` âœ“ ${translations[selectedLang]['current-language']}`;
                    option.innerHTML = displayText;
                    option.appendChild(currentLang);
                } else {
                    option.textContent = displayText;
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                option.addEventListener('click', () => {
                    selectLanguage(lang.code);
                });
                
                languageList.appendChild(option);
            });
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…çš„è¯­è¨€
            if (filteredLanguages.length === 0) {
                const noResult = document.createElement('div');
                noResult.className = 'language-option';
                noResult.textContent = 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è¯­è¨€ / No matching languages found';
                languageList.appendChild(noResult);
            }
        }

        // é€‰æ‹©è¯­è¨€
        function selectLanguage(langCode) {
            // æ›´æ–°æ‰€æœ‰é€‰æ‹©å™¨çš„çŠ¶æ€
            document.querySelectorAll('.language-option').forEach(option => {
                if (option.dataset.code === langCode) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            // åº”ç”¨è¯­è¨€
            applyLanguage(langCode);
        }

        // ä¿å­˜è¯­è¨€åå¥½åˆ°æœåŠ¡å™¨
        async function saveLanguagePreference(langCode) {
            const currentLang = localStorage.getItem('preferred_language') || 'zh';
            
            try {
                const accessToken = localStorage.getItem('access_token');
                
                // å¦‚æœæ²¡æœ‰ç™»å½•ï¼Œæç¤ºé”™è¯¯
                if (!accessToken) {
                    showMessage(translations[currentLang]['message-auth-error'], 'error');
                    return;
                }
                
                const response = await fetch('/api/users/language', {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ language: langCode })
                });
                
                if (response.ok) {
                    showMessage(translations[currentLang]['message-success'], 'success');
                } else {
                    showMessage(translations[currentLang]['message-error'], 'error');
                }
            } catch (error) {
                console.error('Error saving language preference:', error);
                showMessage(translations[currentLang]['message-error'], 'error');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const params = getUrlParams();
            const savedLang = localStorage.getItem('preferred_language');
            const currentLang = params.language || savedLang || 'zh';
            
            // åº”ç”¨å½“å‰è¯­è¨€
            applyLanguage(currentLang);
            
            // æœç´¢æ¡†äº‹ä»¶
            document.getElementById('language-search').addEventListener('input', () => {
                renderLanguageList(localStorage.getItem('preferred_language') || 'zh');
            });
            
            // ä¿å­˜æŒ‰é’®äº‹ä»¶
            document.getElementById('saveBtn').addEventListener('click', async () => {
                const currentLang = localStorage.getItem('preferred_language') || 'zh';
                await saveLanguagePreference(currentLang);
            });
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                // å¦‚æœæ²¡æœ‰ç™»å½•ï¼Œå¯ä»¥ä»ç„¶å…è®¸ç”¨æˆ·æ›´æ”¹è¯­è¨€åå¥½ï¼Œä½†ä¸ä¼šä¿å­˜åˆ°æœåŠ¡å™¨
                document.getElementById('message').textContent = translations[currentLang]['message-auth-error'];
                document.getElementById('message').className = 'message error';
                document.getElementById('message').style.display = 'block';
            } else {
                // å¦‚æœå·²ç™»å½•ï¼Œè·å–ç”¨æˆ·çš„å½“å‰è¯­è¨€åå¥½
                fetchUserProfile();
            }
        });
        
        // è·å–ç”¨æˆ·çš„è¯­è¨€åå¥½
        async function fetchUserProfile() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const currentLang = localStorage.getItem('preferred_language') || 'zh';
                
                const response = await fetch('/api/users/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // å¦‚æœç”¨æˆ·æœ‰å·²ä¿å­˜çš„è¯­è¨€åå¥½ï¼Œåº”ç”¨å®ƒ
                    if (data.preferredLanguage) {
                        applyLanguage(data.preferredLanguage);
                    }
                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
            }
        }
    </script>
</body>
</html> 